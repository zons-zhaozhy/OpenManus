#!/bin/bash

# è®¾ç½®é¢œè‰²
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# è¾“å‡ºå¸¦é¢œè‰²çš„æ¶ˆæ¯
echo_color() {
    color=$1
    message=$2
    echo -e "${color}${message}${NC}"
}

# æ£€æŸ¥Pythonç‰ˆæœ¬
echo_color $GREEN "ğŸš€ å¯åŠ¨ OpenManus AIè½¯ä»¶å…¬å¸..."
echo_color $YELLOW "ğŸ ä½¿ç”¨Python: $(which python)"
python --version

# æ£€æŸ¥Node.jsç‰ˆæœ¬
echo_color $YELLOW "ğŸ“¦ æ£€æŸ¥Node.jsç¯å¢ƒ..."
if ! command -v node &> /dev/null; then
    echo_color $RED "âŒ æœªæ‰¾åˆ°Node.jsï¼Œè¯·å…ˆå®‰è£…Node.js"
    exit 1
fi
echo_color $GREEN "âœ… Node.jsç‰ˆæœ¬: $(node --version)"
echo_color $GREEN "âœ… npmç‰ˆæœ¬: $(npm --version)"

# æ£€æŸ¥ç«¯å£å ç”¨
echo_color $YELLOW "ğŸ” æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ..."
if lsof -i:8000 > /dev/null; then
    echo_color $YELLOW "âš ï¸  ç«¯å£ 8000 è¢«å ç”¨ï¼Œæ­£åœ¨åœæ­¢ç›¸å…³è¿›ç¨‹..."
    kill $(lsof -t -i:8000)
fi

if lsof -i:5173 > /dev/null; then
    echo_color $YELLOW "âš ï¸  ç«¯å£ 5173 è¢«å ç”¨ï¼Œæ­£åœ¨åœæ­¢ç›¸å…³è¿›ç¨‹..."
    kill $(lsof -t -i:5173)
fi

# å¯åŠ¨åç«¯æœåŠ¡
echo_color $YELLOW "ğŸ”¥ å¯åŠ¨åç«¯æœåŠ¡ (ç«¯å£: 8000)..."
python run_mcp_server.py > logs/backend.log 2>&1 &
backend_pid=$!
echo "åç«¯æœåŠ¡ PID: $backend_pid"

# ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨
echo_color $YELLOW "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨ï¼ˆæœ€å¤šç­‰å¾…120ç§’ï¼‰..."
start_time=$(date +%s)
timeout=120

while true; do
    elapsed=$(($(date +%s) - start_time))
    if [ $elapsed -ge $timeout ]; then
        echo_color $RED "âŒ åç«¯æœåŠ¡å¯åŠ¨è¶…æ—¶"
        kill $backend_pid
        exit 1
    fi

    echo_color $YELLOW "   ç­‰å¾…ä¸­... (${elapsed}s/${timeout}s) - åç«¯æ­£åœ¨åˆå§‹åŒ–"
    if curl -s http://localhost:8000/docs > /dev/null; then
        echo_color $GREEN "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ (http://localhost:8000) - è€—æ—¶: ${elapsed}ç§’"
        break
    fi
    sleep 5
done

# å¯åŠ¨å‰ç«¯æœåŠ¡
echo_color $YELLOW "ğŸŒ å¯åŠ¨å‰ç«¯æœåŠ¡ (ç«¯å£: 5173)..."
cd app/web
if [ ! -d "node_modules" ]; then
    echo_color $YELLOW "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
    npm install
fi
npm run dev > ../../logs/frontend.log 2>&1 &
frontend_pid=$!
cd ../..

# ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨
echo_color $YELLOW "â³ ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨ï¼ˆæœ€å¤šç­‰å¾…60ç§’ï¼‰..."
start_time=$(date +%s)
timeout=60

while true; do
    elapsed=$(($(date +%s) - start_time))
    if [ $elapsed -ge $timeout ]; then
        echo_color $RED "âŒ å‰ç«¯æœåŠ¡å¯åŠ¨è¶…æ—¶"
        kill $frontend_pid
        kill $backend_pid
        exit 1
    fi

    echo_color $YELLOW "   ç­‰å¾…ä¸­... (${elapsed}s/${timeout}s) - å‰ç«¯æ­£åœ¨åˆå§‹åŒ–"
    if curl -s http://localhost:5173 > /dev/null; then
        echo_color $GREEN "âœ… å‰ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ (http://localhost:5173) - è€—æ—¶: ${elapsed}ç§’"
        break
    fi
    sleep 5
done

# ä¿å­˜è¿›ç¨‹ID
echo "$backend_pid" > .openmanus_pids
echo "$frontend_pid" >> .openmanus_pids

# è¾“å‡ºå¯åŠ¨æˆåŠŸä¿¡æ¯
echo_color $GREEN "ğŸ‰ OpenManus AIè½¯ä»¶å…¬å¸å¯åŠ¨å®Œæˆï¼"
echo_color $YELLOW "ğŸ“‹ æœåŠ¡ä¿¡æ¯ï¼š"
echo "   åç«¯æœåŠ¡: http://localhost:8000"
echo "   å‰ç«¯æœåŠ¡: http://localhost:5173"
echo "   API æ–‡æ¡£: http://localhost:8000/docs"
echo_color $YELLOW "ğŸ“ æ—¥å¿—æ–‡ä»¶ï¼š"
echo "   åç«¯æ—¥å¿—: logs/backend.log"
echo "   å‰ç«¯æ—¥å¿—: logs/frontend.log"
echo_color $YELLOW "ğŸ›‘ åœæ­¢æœåŠ¡ï¼š"
echo "   kill $backend_pid $frontend_pid"
echo_color $GREEN "âœ¨ æœåŠ¡è¿›ç¨‹IDå·²ä¿å­˜åˆ° .openmanus_pids æ–‡ä»¶"
